---
title: "README"
output: github_document
date: "2023-08-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, echo = T, message = F)
```

## Fair Housing Map

In process documentation for CTCAC/HCD Opportunity and Neighborhood Change Map package, temporarily called the "Fair Housing Map" until further directed by CTCAC and HCD.

### Installation

1.  Clone repository

2.  Download data-raw directory and extract into root directory: <https://berkeley.app.box.com/folder/224592265510>

3.  Open package using "fairHousingMap.Rproj" file

4.  Load package and install dependencies:

```{r}
devtools::install_dev_deps()
```

```{r}
devtools::load_all()
```

### Census API

1.  Register for Census API key [here](https://api.census.gov/data/key_signup.html).

2.  Install the key in the tidycensus package. See `?tidycensus::census_api_key()` for details

3.  Build directory paths not included in repository: 'data/intermediate/2024/' and 'output/2024/'

### Directory Structure

-   *data* - .Rda files of census polygon geographies.

    -   *intermediate* - intermediate data files.

-   *analysis* - .Rmd files of internal reports, exploratory analysis, etc.

-   *output* - Published datasets

-   *README* - project root documentation

-   *.gitignore* - instructions for git to ignore files

-   *R* - R package functions, executes all code that goes into published tables and maps

-   *map* - javascript webmaps

-   *tests* - testthat tests to ensure package is working as expected

### TODO

-   Develop testthat test suite.
-   The legacy packages maptools, rgdal, and rgeos, underpinning the sp package, which is a dependency, will retire in October 2023. Replace functions that depend on sp with sf package equivalents.

### Sequence

Generating the final opportunity designations requires a series of functions that must be called in a specific order.

**01_census_geography.R** contains functions for reading tract, block group, and block population weighted centroids. No intermediate files are written. The centroid-reading functions are called within other subsequent scripts.

```{r}
head(read_tract_centers())
```

**02_create_rural_shapefile.R** contains the shape_rural() function, which imports the USDA shapefile for areas ineligible for rural designation, then shrinks to only California data and subtracts them from the complete California shapefile to get a rural areas shapefile. This generates the first file, rural_shapefile.shp, which , which must exist in the intermediate directory to proceed further.

```{r}
shape_rural(write = F) # write = T will generate a new file
```

```{r}
# to map the shapefile
mapview::mapview(shape_rural(write = F))
```

**03_create_region_designation.R** contains create_regions(), which evaluates which regions that each county belongs to, then uses rural_overlay() to pinpoint rural tracts. rural_overlay() merges block centers with the rural_shapefile, and classifies the population of any block with its centroid inside the rural shapefile as rural. It then collapses to tract level, and any tract with over 50 percent population rural is classified as "Rural Areas." rural_overlay() is executed within the create_regions() function, and is separated for testing convenience only. For creating data, only create_regions() is necessary to run.

```{r}
head(create_regions(read = T)) # reads the existing file, set to False to generate new
```

....

**08_final_data.R** contains final_raw() which loads and combines all intermediate files with economic, education, and environmental indicators. final_prepare() then creates the high poverty and segregated designation and flags unreliable data. Finally, final_opp() creates the final opportunity scores and designations. final_raw() and final_prepare() are both inputs into the final_opp() function. Only final_opp() is necessary to run for generating new data.

```{r}
head(final_opp())
```

```{r}
# to map the output, use as_geo = T
mapview::mapview(final_opp(as_geo = T), zcol = 'oppcat')
```
